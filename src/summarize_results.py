import json
import pandas as pd
from pathlib import Path
from datetime import datetime

output_dir = Path("outputs")
output_dir.mkdir(parents=True, exist_ok=True)

def latest_file(path: Path, pattern: str):
    files = sorted(path.glob(pattern), key=lambda p: p.stat().st_mtime, reverse=True)
    return files[0] if files else None

ate_file = latest_file(output_dir, "*.csv")
ate_df = None
if ate_file:
    try:
        ate_df = pd.read_csv(ate_file)
        print(f"Loaded ATE CSV: {ate_file.name}")
    except Exception as e:
        print("Failed to read ATE CSV:", e)

ref_file = latest_file(output_dir, "*.json")
refutation = None
if ref_file:
    try:
        with open(ref_file, "r", encoding="utf-8") as f:
            refutation = json.load(f)
        print(f"Loaded refutation JSON: {ref_file.name}")
    except Exception as e:
        print("Failed to load JSON:", e)

def format_refutation_value(val):

    if val is None:
        return "N/A"
    if isinstance(val, dict):
        parts = []
        for k in ("refuter", "new_effect", "p_value", "test_type", "refutation_string"):
            if k in val:
                parts.append(f"{k}: {val[k]}")
        if parts:
            return "; ".join(map(str, parts))
        return json.dumps(val, ensure_ascii=False)
    if isinstance(val, list):
        return "; ".join([format_refutation_value(x) for x in val])
    return str(val)

lines = []
lines.append("# üß† Causal Analysis Summary")
lines.append(f"Generated: {datetime.now().isoformat()}\n")

# ATE section
if ate_df is not None and not ate_df.empty:
    lines.append("## üìä Average Treatment Effect (ATE) Summary\n")
    for _, row in ate_df.iterrows():
        estimator = row.get("estimator_label") or row.get("Estimator") or row.get("estimator") or row.get("method_name") or "Unknown"
        ate_val = row.get("ate") if "ate" in row else row.get("ATE", "N/A")
        ci = row.get("CI") or row.get("confidence_interval") or "N/A"
        lines.append(f"- **Estimator:** {estimator}")
        lines.append(f"  - ATE Value: {ate_val}")
        lines.append(f"  - Confidence Interval: {ci}\n")
else:
    lines.append("## üìä Average Treatment Effect (ATE) Summary\n- No ATE CSV found or file is empty.\n")

# Refutation section
if refutation:
    lines.append("## üîÅ Refutation Test Results\n")
    if isinstance(refutation, dict):
        for key, value in refutation.items():
            lines.append(f"### {key}")
            if isinstance(value, dict) and "refutations" in value:
                for ref_name, ref_val in value["refutations"].items():
                    lines.append(f"- **{ref_name}:** {format_refutation_value(ref_val)}")
            elif isinstance(value, dict):
                for ref_name, ref_val in value.items():
                    lines.append(f"- **{ref_name}:** {format_refutation_value(ref_val)}")
            else:
                lines.append(f"- {format_refutation_value(value)}")
            lines.append("")  
    elif isinstance(refutation, list):
        for item in refutation:
            lines.append(f"- {format_refutation_value(item)}")
    else:
        lines.append(f"- {format_refutation_value(refutation)}")
else:
    lines.append("## üîÅ Refutation Test Results\n- No refutation JSON found.\n")

lines.append("---")
lines.append("‚úÖ Summary generated by summarize_results.py")

md_path = output_dir / "causal_summary.md"
txt_path = output_dir / "causal_summary.txt"
with open(md_path, "w", encoding="utf-8") as f:
    f.write("\n".join(lines))
with open(txt_path, "w", encoding="utf-8") as f:
    f.write("\n".join(lines))

print(f"Saved summary files:\n - {md_path}\n - {txt_path}")
